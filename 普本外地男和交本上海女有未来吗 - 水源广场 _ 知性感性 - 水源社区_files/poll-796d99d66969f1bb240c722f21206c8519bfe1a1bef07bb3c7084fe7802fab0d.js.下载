define("discourse/plugins/poll/discourse/components/modal/poll-breakdown",["exports","@ember/component","@ember/object","@ember/service","@ember/string","@ember/template","discourse/lib/ajax","discourse/lib/ajax-error","discourse/lib/load-script","discourse-common/utils/decorators","discourse-i18n","@ember/template-factory"],(function(t,e,l,o,s,i,n,a,r,p,u,d){"use strict"
Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0
const c=(0,d.createTemplateFactory)({id:"YRvkhP/Q",block:'[[[8,[39,0],[[24,0,"poll-breakdown has-tabs"]],[["@title","@closeModal"],[[28,[37,1],["poll.breakdown.title"],null],[30,1]]],[["headerBelowTitle","body"],[[[[1,"\\n    "],[10,"ul"],[14,0,"modal-tabs"],[12],[1,"\\n      "],[11,"li"],[16,0,[28,[37,2],["modal-tab percentage",[52,[28,[37,4],[[30,0,["displayMode"]],"percentage"],null],"is-active"]],null]],[4,[38,5],["click",[28,[37,6],[[28,[37,7],[[30,0,["displayMode"]]],null],"percentage"],null]],null],[12],[1,[28,[35,1],["poll.breakdown.percentage"],null]],[13],[1,"\\n      "],[11,"li"],[16,0,[28,[37,2],["modal-tab count",[52,[28,[37,4],[[30,0,["displayMode"]],"count"],null],"is-active"]],null]],[4,[38,5],["click",[28,[37,6],[[28,[37,7],[[30,0,["displayMode"]]],null],"count"],null]],null],[12],[1,[28,[35,1],["poll.breakdown.count"],null]],[13],[1,"\\n    "],[13],[1,"\\n  "]],[]],[[[1,"\\n    "],[10,0],[14,0,"poll-breakdown-sidebar"],[12],[1,"\\n      "],[10,2],[14,0,"poll-breakdown-title"],[12],[1,"\\n        "],[1,[30,0,["title"]]],[1,"\\n      "],[13],[1,"\\n\\n      "],[10,0],[14,0,"poll-breakdown-total-votes"],[12],[1,[28,[35,1],["poll.breakdown.votes"],[["count"],[[30,0,["model","poll","voters"]]]]]],[13],[1,"\\n\\n      "],[10,"ul"],[14,0,"poll-breakdown-options"],[12],[1,"\\n"],[42,[28,[37,9],[[28,[37,9],[[30,0,["model","poll","options"]]],null]],null],null,[[[1,"          "],[8,[39,10],null,[["@option","@index","@totalVotes","@optionsCount","@displayMode","@highlightedOption","@onMouseOver","@onMouseOut"],[[30,2],[30,3],[30,0,["totalVotes"]],[30,0,["model","poll","options","length"]],[30,0,["displayMode"]],[30,0,["highlightedOption"]],[28,[37,6],[[28,[37,7],[[30,0,["highlightedOption"]]],null],[30,3]],null],[28,[37,6],[[28,[37,7],[[30,0,["highlightedOption"]]],null],null],null]]],null],[1,"\\n"]],[2,3]],null],[1,"      "],[13],[1,"\\n    "],[13],[1,"\\n\\n    "],[10,0],[14,0,"poll-breakdown-body"],[12],[1,"\\n      "],[10,0],[14,0,"poll-breakdown-body-header"],[12],[1,"\\n        "],[10,"label"],[14,0,"poll-breakdown-body-header-label"],[12],[1,[28,[35,1],["poll.breakdown.breakdown"],null]],[13],[1,"\\n\\n        "],[8,[39,11],[[24,0,"poll-breakdown-dropdown"]],[["@content","@value","@nameProperty","@onChange"],[[30,0,["groupableUserFields"]],[30,0,["groupedBy"]],"label",[30,0,["setGrouping"]]]],null],[1,"\\n      "],[13],[1,"\\n\\n      "],[10,0],[14,0,"poll-breakdown-charts"],[12],[1,"\\n"],[42,[28,[37,9],[[28,[37,9],[[30,0,["charts"]]],null]],null],null,[[[1,"          "],[8,[39,12],null,[["@group","@options","@displayMode","@highlightedOption","@setHighlightedOption"],[[28,[37,13],[[30,4],"group"],null],[28,[37,13],[[30,4],"options"],null],[30,0,["displayMode"]],[30,0,["highlightedOption"]],[28,[37,6],[[28,[37,7],[[30,0,["highlightedOption"]]],null]],null]]],null],[1,"\\n"]],[4]],null],[1,"      "],[13],[1,"\\n    "],[13],[1,"\\n  "]],[]]]]]],["@closeModal","option","index","chart"],false,["d-modal","i18n","concat-class","if","eq","on","fn","mut","each","-track-array","poll-breakdown-option","combo-box","poll-breakdown-chart","get"]]',moduleName:"discourse/plugins/poll/discourse/components/modal/poll-breakdown.hbs",isStrictMode:!1})
class h extends e.default{static#t=(()=>dt7948.g(this.prototype,"dialog",[o.service]))()
#e=(()=>{dt7948.i(this,"dialog")})()
model=null
charts=null
groupedBy=null
highlightedOption=null
displayMode="percentage"
init(){this.set("groupedBy",this.model.groupableUserFields[0]),(0,r.default)("/javascripts/Chart.min.js").then((()=>(0,r.default)("/javascripts/chartjs-plugin-datalabels.min.js"))).then((()=>{this.fetchGroupedPollData()})),super.init(...arguments)}title(t,e){return t?(0,i.htmlSafe)(t):e}static#l=(()=>dt7948.n(this.prototype,"title",[(0,p.default)("model.poll.title","model.post.topic.title")]))()
groupableUserFields(t){return t.map((t=>{const e=t.split("_").filter(Boolean)
return e.length>1&&(e[0]=(0,s.classify)(e[0])),{id:t,label:e.join(" ")}}))}static#o=(()=>dt7948.n(this.prototype,"groupableUserFields",[(0,p.default)("model.groupableUserFields")]))()
totalVotes(t){return t.reduce(((t,e)=>t+e.votes),0)}static#s=(()=>dt7948.n(this.prototype,"totalVotes",[(0,p.default)("model.poll.options")]))()
fetchGroupedPollData(){return(0,n.ajax)("/polls/grouped_poll_results.json",{data:{post_id:this.model.post.id,poll_name:this.model.poll.name,user_field_name:this.groupedBy}}).catch((t=>{t?(0,a.popupAjaxError)(t):this.dialog.alert(u.default.t("poll.error_while_fetching_voters"))})).then((t=>{this.isDestroying||this.isDestroyed||this.set("charts",t.grouped_results)}))}setGrouping(t){this.set("groupedBy",t),this.fetchGroupedPollData()}static#i=(()=>dt7948.n(this.prototype,"setGrouping",[l.action]))()
onSelectPanel(t){this.set("displayMode",t.id)}static#n=(()=>dt7948.n(this.prototype,"onSelectPanel",[l.action]))()}t.default=h,(0,e.setComponentTemplate)(c,h)})),define("discourse/plugins/poll/discourse/components/modal/poll-ui-builder",["exports","@ember/component","@ember/object","@ember/object/computed","@ember/service","@ember-decorators/object","discourse-common/utils/decorators","discourse-i18n","@ember/template-factory"],(function(t,e,l,o,s,i,n,a,r){"use strict"
Object.defineProperty(t,"__esModule",{value:!0}),t.default=t.REGULAR_POLL_TYPE=t.PIE_CHART_TYPE=t.NUMBER_POLL_TYPE=t.MULTIPLE_POLL_TYPE=t.BAR_CHART_TYPE=void 0
const p=(0,r.createTemplateFactory)({id:"TcibS1xt",block:'[[[8,[39,0],[[24,0,"poll-ui-builder"]],[["@title","@closeModal","@inline"],[[28,[37,1],["poll.ui_builder.title"],null],[30,1],[30,2]]],[["body","footer"],[[[[1,"\\n    "],[10,"ul"],[14,0,"nav nav-pills poll-type"],[12],[1,"\\n      "],[10,"li"],[12],[1,"\\n        "],[11,3],[24,6,""],[16,0,[29,["poll-type-value poll-type-value-regular\\n            ",[52,[30,0,["isRegular"]],"active"]]]],[4,[38,3],["click",[28,[37,4],[[30,0,["updatePollType"]],"regular"],null]],null],[12],[1,"\\n          "],[1,[28,[35,1],["poll.ui_builder.poll_type.regular"],null]],[1,"\\n        "],[13],[1,"\\n      "],[13],[1,"\\n      "],[10,"li"],[12],[1,"\\n        "],[11,3],[24,6,""],[16,0,[29,["poll-type-value poll-type-value-multiple\\n            ",[52,[30,0,["isMultiple"]],"active"]]]],[4,[38,3],["click",[28,[37,4],[[30,0,["updatePollType"]],"multiple"],null]],null],[12],[1,"\\n          "],[1,[28,[35,1],["poll.ui_builder.poll_type.multiple"],null]],[1,"\\n        "],[13],[1,"\\n      "],[13],[1,"\\n"],[41,[30,0,["showNumber"]],[[[1,"        "],[10,"li"],[12],[1,"\\n          "],[11,3],[24,6,""],[16,0,[29,["poll-type-value poll-type-value-number\\n              ",[52,[30,0,["isNumber"]],"active"]]]],[4,[38,3],["click",[28,[37,4],[[30,0,["updatePollType"]],"number"],null]],null],[12],[1,"\\n            "],[1,[28,[35,1],["poll.ui_builder.poll_type.number"],null]],[1,"\\n          "],[13],[1,"\\n        "],[13],[1,"\\n"]],[]],null],[1,"    "],[13],[1,"\\n\\n"],[41,[30,0,["showAdvanced"]],[[[1,"      "],[10,0],[14,0,"input-group poll-title"],[12],[1,"\\n        "],[10,"label"],[14,0,"input-group-label"],[12],[1,[28,[35,1],["poll.ui_builder.poll_title.label"],null]],[13],[1,"\\n        "],[8,[39,5],null,[["@value"],[[30,0,["pollTitle"]]]],null],[1,"\\n      "],[13],[1,"\\n"]],[]],null],[1,"\\n"],[41,[51,[30,0,["isNumber"]]],[[[1,"      "],[10,0],[14,0,"poll-options"],[12],[1,"\\n"],[41,[30,0,["showAdvanced"]],[[[1,"          "],[10,"label"],[14,0,"input-group-label"],[12],[1,[28,[35,1],["poll.ui_builder.poll_options.label"],null]],[13],[1,"\\n          "],[8,[39,7],[[4,[38,3],["input",[30,0,["onOptionsTextChange"]]],null]],[["@value"],[[30,0,["pollOptionsText"]]]],null],[1,""],[41,[30,0,["showMinNumOfOptionsValidation"]],[[[41,[51,[30,0,["minNumOfOptionsValidation","ok"]]],[[[1,"              "],[8,[39,8],null,[["@validation"],[[30,0,["minNumOfOptionsValidation"]]]],null],[1,"\\n"]],[]],null]],[]],null]],[]],[[[42,[28,[37,10],[[28,[37,10],[[30,0,["pollOptions"]]],null]],null],null,[[[1,"            "],[10,0],[14,0,"input-group poll-option-value"],[12],[1,"\\n              "],[11,"input"],[16,2,[30,3,["value"]]],[24,4,"text"],[4,[38,11],null,null],[4,[38,3],["input",[28,[37,4],[[30,0,["updateValue"]],[30,3]],null]],null],[4,[38,3],["keydown",[28,[37,4],[[30,0,["onInputKeydown"]],[30,4]],null]],null],[12],[13],[1,"\\n"],[41,[30,0,["canRemoveOption"]],[[[1,"                "],[8,[39,12],null,[["@icon","@action"],["trash-alt",[28,[37,4],[[30,0,["removeOption"]],[30,3]],null]]],null],[1,"\\n"]],[]],null],[1,"            "],[13],[1,"\\n"]],[3,4]],null],[1,"\\n          "],[10,0],[14,0,"poll-option-controls"],[12],[1,"\\n            "],[8,[39,12],[[24,0,"btn-default poll-option-add"]],[["@icon","@label","@action"],["plus","poll.ui_builder.poll_options.add",[28,[37,4],[[30,0,["addOption"]],-1],null]]],null],[1,"\\n"],[41,[28,[37,13],[[30,0,["showMinNumOfOptionsValidation"]],[28,[37,14],[[30,0,["minNumOfOptionsValidation","ok"]]],null]],null],[[[1,"              "],[8,[39,8],null,[["@validation"],[[30,0,["minNumOfOptionsValidation"]]]],null],[1,"\\n"]],[]],null],[1,"          "],[13],[1,"\\n"]],[]]],[1,"      "],[13],[1,"\\n"]],[]],null],[1,"\\n"],[41,[51,[30,0,["isRegular"]]],[[[1,"      "],[10,0],[14,0,"options"],[12],[1,"\\n        "],[10,0],[14,0,"input-group poll-number"],[12],[1,"\\n          "],[10,"label"],[14,0,"input-group-label"],[12],[1,[28,[35,1],["poll.ui_builder.poll_config.min"],null]],[13],[1,"\\n          "],[8,[39,5],[[24,0,"poll-options-min"],[24,"min","1"]],[["@type","@value"],["number",[30,0,["pollMin"]]]],null],[1,"\\n        "],[13],[1,"\\n\\n        "],[10,0],[14,0,"input-group poll-number"],[12],[1,"\\n          "],[10,"label"],[14,0,"input-group-label"],[12],[1,[28,[35,1],["poll.ui_builder.poll_config.max"],null]],[13],[1,"\\n          "],[8,[39,5],[[24,0,"poll-options-max"],[24,"min","1"]],[["@type","@value"],["number",[30,0,["pollMax"]]]],null],[1,"\\n        "],[13],[1,"\\n\\n"],[41,[30,0,["isNumber"]],[[[1,"          "],[10,0],[14,0,"input-group poll-number"],[12],[1,"\\n            "],[10,"label"],[14,0,"input-group-label"],[12],[1,[28,[35,1],["poll.ui_builder.poll_config.step"],null]],[13],[1,"\\n            "],[8,[39,5],[[24,"min","1"],[24,0,"poll-options-step"]],[["@type","@value"],["number",[30,0,["pollStep"]]]],null],[1,"\\n          "],[13],[1,"\\n"]],[]],null],[1,"      "],[13],[1,"\\n\\n"],[41,[51,[30,0,["minMaxValueValidation","ok"]]],[[[1,"        "],[8,[39,8],null,[["@validation"],[[30,0,["minMaxValueValidation"]]]],null],[1,"\\n"]],[]],null]],[]],null],[1,"\\n    "],[10,0],[14,0,"input-group poll-public"],[12],[1,"\\n      "],[8,[39,15],[[24,0,"poll-toggle-public"],[4,[38,3],["click",[30,0,["togglePublic"]]],null]],[["@state","@label"],[[30,0,["publicPoll"]],"poll.ui_builder.poll_public.label"]],null],[1,"\\n    "],[13],[1,"\\n\\n"],[41,[30,0,["showAdvanced"]],[[[1,"      "],[10,0],[14,0,"input-group poll-allowed-groups"],[12],[1,"\\n        "],[10,"label"],[14,0,"input-group-label"],[12],[1,[28,[35,1],["poll.ui_builder.poll_groups.label"],null]],[13],[1,"\\n        "],[8,[39,16],null,[["@content","@value","@onChange","@labelProperty","@valueProperty"],[[30,0,["siteGroups"]],[30,0,["pollGroups"]],[28,[37,4],[[28,[37,17],[[30,0,["pollGroups"]]],null]],null],"name","name"]],null],[1,"\\n      "],[13],[1,"\\n\\n      "],[10,0],[14,0,"input-group poll-date"],[12],[1,"\\n        "],[10,"label"],[14,0,"input-group-label"],[12],[1,[28,[35,1],["poll.ui_builder.automatic_close.label"],null]],[13],[1,"\\n        "],[8,[39,18],null,[["@date","@onChange","@clearable","@useGlobalPickerContainer"],[[30,0,["pollAutoClose"]],[28,[37,4],[[28,[37,17],[[30,0,["pollAutoClose"]]],null]],null],true,true]],null],[1,"\\n      "],[13],[1,"\\n\\n      "],[10,0],[14,0,"input-group poll-select"],[12],[1,"\\n        "],[10,"label"],[14,0,"input-group-label"],[12],[1,[28,[35,1],["poll.ui_builder.poll_result.label"],null]],[13],[1,"\\n        "],[8,[39,19],[[24,0,"poll-result"]],[["@content","@value","@valueProperty","@onChange"],[[30,0,["pollResults"]],[30,0,["pollResult"]],"value",[28,[37,4],[[28,[37,17],[[30,0,["pollResult"]]],null]],null]]],null],[1,"\\n      "],[13],[1,"\\n\\n"],[41,[51,[30,0,["isNumber"]]],[[[1,"        "],[10,0],[14,0,"input-group poll-select column"],[12],[1,"\\n          "],[10,"label"],[14,0,"input-group-label"],[12],[1,[28,[35,1],["poll.ui_builder.poll_chart_type.label"],null]],[13],[1,"\\n\\n          "],[10,0],[14,0,"radio-group"],[12],[1,"\\n            "],[8,[39,20],null,[["@id","@name","@value","@selection"],["poll-chart-type-bar","poll-chart-type","bar",[30,0,["chartType"]]]],null],[1,"\\n            "],[10,"label"],[14,"for","poll-chart-type-bar"],[12],[1,[28,[35,21],["chart-bar"],null]],[1,"\\n              "],[1,[28,[35,1],["poll.ui_builder.poll_chart_type.bar"],null]],[13],[1,"\\n          "],[13],[1,"\\n\\n          "],[10,0],[14,0,"radio-group"],[12],[1,"\\n            "],[8,[39,20],null,[["@id","@name","@value","@selection"],["poll-chart-type-pie","poll-chart-type","pie",[30,0,["chartType"]]]],null],[1,"\\n            "],[10,"label"],[14,"for","poll-chart-type-pie"],[12],[1,[28,[35,21],["chart-pie"],null]],[1,"\\n              "],[1,[28,[35,1],["poll.ui_builder.poll_chart_type.pie"],null]],[13],[1,"\\n          "],[13],[1,"\\n        "],[13],[1,"\\n"]],[]],null]],[]],null],[1,"  "]],[]],[[[1,"\\n    "],[8,[39,12],[[24,0,"btn-primary insert-poll"]],[["@action","@icon","@label","@disabled"],[[30,0,["insertPoll"]],"chart-bar","poll.ui_builder.insert",[30,0,["disableInsert"]]]],null],[1,"\\n\\n    "],[8,[39,12],[[24,0,"btn-flat"]],[["@label","@action"],["cancel",[30,1]]],null],[1,"\\n\\n    "],[8,[39,12],[[24,0,"btn-default show-advanced"]],[["@action","@icon","@title"],[[30,0,["toggleAdvanced"]],"cog",[52,[30,0,["showAdvanced"]],"poll.ui_builder.hide_advanced","poll.ui_builder.show_advanced"]]],null],[1,"\\n\\n  "]],[]]]]]],["@closeModal","@inline","option","index"],false,["d-modal","i18n","if","on","fn","input","unless","textarea","input-tip","each","-track-array","auto-focus","d-button","and","not","d-toggle-switch","group-chooser","mut","date-time-input","combo-box","radio-button","d-icon"]]',moduleName:"discourse/plugins/poll/discourse/components/modal/poll-ui-builder.hbs",isStrictMode:!1}),u=t.BAR_CHART_TYPE="bar",d=t.PIE_CHART_TYPE="pie",c=t.REGULAR_POLL_TYPE="regular",h=t.NUMBER_POLL_TYPE="number",m=t.MULTIPLE_POLL_TYPE="multiple",g="always"
class f extends e.default{static#t=(()=>dt7948.g(this.prototype,"siteSettings",[s.service]))()
#a=(()=>{dt7948.i(this,"siteSettings")})()
showAdvanced=!1
pollType=(()=>c)()
pollTitle
pollOptions=(()=>[l.default.create({value:""})])()
pollOptionsText=""
pollMin=1
pollMax=2
pollStep=1
pollGroups
pollAutoClose
pollResult=(()=>g)()
chartType=(()=>u)()
publicPoll=(()=>this.siteSettings.poll_default_public)()
static#l=(()=>dt7948.g(this.prototype,"showNumber",[(0,o.or)("showAdvanced","isNumber")]))()
#r=(()=>{dt7948.i(this,"showNumber")})()
static#o=(()=>dt7948.g(this.prototype,"canRemoveOption",[(0,o.gt)("pollOptions.length",1)]))()
#p=(()=>{dt7948.i(this,"canRemoveOption")})()
pollResults(t){const e=[{name:a.default.t("poll.ui_builder.poll_result.always"),value:g},{name:a.default.t("poll.ui_builder.poll_result.vote"),value:"on_vote"},{name:a.default.t("poll.ui_builder.poll_result.closed"),value:"on_close"}]
return t&&e.push({name:a.default.t("poll.ui_builder.poll_result.staff"),value:"staff_only"}),e}static#s=(()=>dt7948.n(this.prototype,"pollResults",[(0,n.default)("currentUser.staff")]))()
isRegular(t){return t===c}static#i=(()=>dt7948.n(this.prototype,"isRegular",[(0,n.default)("pollType")]))()
isNumber(t){return t===h}static#n=(()=>dt7948.n(this.prototype,"isNumber",[(0,n.default)("pollType")]))()
isMultiple(t){return t===m}static#u=(()=>dt7948.n(this.prototype,"isMultiple",[(0,n.default)("pollType")]))()
pollOptionsCount(t){return(t||[]).filter((t=>t.value.length>0)).length}static#d=(()=>dt7948.n(this.prototype,"pollOptionsCount",[(0,n.default)("pollOptions.@each.value")]))()
siteGroups(t){return t.filter((t=>0!==t.id))}static#c=(()=>dt7948.n(this.prototype,"siteGroups",[(0,n.default)("site.groups")]))()
isPie(t,e){return e!==h&&t===d}static#h=(()=>dt7948.n(this.prototype,"isPie",[(0,n.default)("chartType","pollType")]))()
_setPollMinMax(){this.isMultiple?((this.pollMin<=0||this.pollMin>=this.pollMax||this.pollMin>=this.pollOptionsCount)&&this.set("pollMin",this.pollOptionsCount>0?1:0),(this.pollMax<=0||this.pollMin>=this.pollMax||this.pollMax>this.pollOptionsCount)&&this.set("pollMax",this.pollOptionsCount)):this.isNumber&&this.set("pollMax",this.siteSettings.poll_maximum_options)}static#m=(()=>dt7948.n(this.prototype,"_setPollMinMax",[(0,i.observes)("pollType","pollOptionsCount")]))()
pollOutput(t,e,l,o,s,i,n,a,r,p,u){let d="[poll",m=""
const g=this.model.toolbarEvent.getText().match(/\[poll(\s+name=[^\s\]]+)*.*\]/gim)
g&&(d+=` name=poll${g.length+1}`)
let f=a
return f<1&&(f=1),t&&(d+=` type=${t}`),e&&(d+=` results=${e}`),i&&t!==c&&(d+=` min=${i}`),n&&t!==c&&(d+=` max=${n}`),t===h&&(d+=` step=${f}`),d+=" public="+(l?"true":"false"),u&&t!==h&&(d+=` chartType=${u}`),r&&r.length>0&&(d+=` groups=${r}`),p&&(d+=` close=${p.toISOString()}`),d+="]",m+=`${d}\n`,o&&(m+=`# ${o.trim()}\n`),s.length>0&&t!==h&&s.forEach((t=>{t.value.length>0&&(m+=`* ${t.value.trim()}\n`)})),m+="[/poll]\n",m}static#g=(()=>dt7948.n(this.prototype,"pollOutput",[(0,n.default)("pollType","pollResult","publicPoll","pollTitle","pollOptions.@each.value","pollMin","pollMax","pollStep","pollGroups","pollAutoClose","chartType")]))()
minNumOfOptionsValidation(t,e){if(!t){if(e<1)return l.default.create({failed:!0,reason:a.default.t("poll.ui_builder.help.options_min_count")})
if(e>this.siteSettings.poll_maximum_options)return l.default.create({failed:!0,reason:a.default.t("poll.ui_builder.help.options_max_count",{count:this.siteSettings.poll_maximum_options})})}return l.default.create({ok:!0})}static#f=(()=>dt7948.n(this.prototype,"minNumOfOptionsValidation",[(0,n.default)("isNumber","pollOptionsCount")]))()
showMinNumOfOptionsValidation(t){return 1!==t.length||""!==t[0].value}static#b=(()=>dt7948.n(this.prototype,"showMinNumOfOptionsValidation",[(0,n.default)("pollOptions.@each.value")]))()
minMaxValueValidation(t,e,o,s,i,n){if(s=parseInt(s,10)||0,i=parseInt(i,10)||0,n=parseInt(n,10)||0,s<0)return l.default.create({failed:!0,reason:a.default.t("poll.ui_builder.help.invalid_min_value")})
if(i<0||t&&i>e)return l.default.create({failed:!0,reason:a.default.t("poll.ui_builder.help.invalid_max_value")})
if(s>i)return l.default.create({failed:!0,reason:a.default.t("poll.ui_builder.help.invalid_values")})
if(o){if(n<1)return l.default.create({failed:!0,reason:a.default.t("poll.ui_builder.help.min_step_value")})
const t=(i-s+1)/n
if(t<1)return l.default.create({failed:!0,reason:a.default.t("poll.ui_builder.help.options_min_count")})
if(t>this.siteSettings.poll_maximum_options)return l.default.create({failed:!0,reason:a.default.t("poll.ui_builder.help.options_max_count",{count:this.siteSettings.poll_maximum_options})})}return l.default.create({ok:!0})}static#_=(()=>dt7948.n(this.prototype,"minMaxValueValidation",[(0,n.default)("isMultiple","pollOptionsCount","isNumber","pollMin","pollMax","pollStep")]))()
disableInsert(t,e){return!t.ok||!e.ok}static#v=(()=>dt7948.n(this.prototype,"disableInsert",[(0,n.default)("minMaxValueValidation","minNumOfOptionsValidation")]))()
_comboboxOptions(t,e){return[...Array(e-t).keys()].map((e=>({value:e+t,name:e+t})))}onOptionsTextChange(t){this.set("pollOptions",t.target.value.split("\n").map((t=>l.default.create({value:t}))))}static#y=(()=>dt7948.n(this.prototype,"onOptionsTextChange",[l.action]))()
insertPoll(){this.model.toolbarEvent.addText(this.pollOutput),this.closeModal()}static#w=(()=>dt7948.n(this.prototype,"insertPoll",[l.action]))()
toggleAdvanced(){this.toggleProperty("showAdvanced"),this.showAdvanced&&this.set("pollOptionsText",this.pollOptions.map((t=>t.value)).join("\n"))}static#x=(()=>dt7948.n(this.prototype,"toggleAdvanced",[l.action]))()
updateValue(t,e){t.set("value",e.target.value)}static#M=(()=>dt7948.n(this.prototype,"updateValue",[l.action]))()
onInputKeydown(t,e){"Enter"===e.key&&(e.preventDefault(),e.stopPropagation(),""!==e.target.value&&this.addOption(t+1))}static#O=(()=>dt7948.n(this.prototype,"onInputKeydown",[l.action]))()
addOption(t){-1===t&&(t=this.pollOptions.length)
const e=l.default.create({value:""})
this.pollOptions.insertAt(t,e)}static#C=(()=>dt7948.n(this.prototype,"addOption",[l.action]))()
removeOption(t){this.pollOptions.removeObject(t)}static#k=(()=>dt7948.n(this.prototype,"removeOption",[l.action]))()
updatePollType(t,e){e?.preventDefault(),this.set("pollType",t)}static#T=(()=>dt7948.n(this.prototype,"updatePollType",[l.action]))()
togglePublic(){this.set("publicPoll",!this.publicPoll)}static#P=(()=>dt7948.n(this.prototype,"togglePublic",[l.action]))()}t.default=f,(0,e.setComponentTemplate)(p,f)})),define("discourse/plugins/poll/discourse/components/poll-breakdown-chart",["exports","@ember/component","@ember/object/computed","@ember/runloop","@ember/template","@ember-decorators/component","discourse-common/utils/decorators","discourse-i18n","discourse/plugins/poll/lib/chart-colors","discourse/plugins/poll/discourse/components/modal/poll-ui-builder","@ember/template-factory"],(function(t,e,l,o,s,i,n,a,r,p,u){"use strict"
Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0
const d=(0,u.createTemplateFactory)({id:"oqA5wA7R",block:'[[[10,"label"],[14,0,"poll-breakdown-chart-label"],[12],[1,[30,1]],[13],[1,"\\n"],[10,"canvas"],[14,0,"poll-breakdown-chart-chart"],[12],[13]],["@group"],false,[]]',moduleName:"discourse/plugins/poll/discourse/components/poll-breakdown-chart.hbs",isStrictMode:!1}),c=dt7948.c(class extends e.default{group=null
options=null
displayMode=null
highlightedOption=null
setHighlightedOption=null
static#t=(()=>dt7948.g(this.prototype,"data",[(0,l.mapBy)("options","votes")]))()
#S=(()=>{dt7948.i(this,"data")})()
_optionToSlice=null
_previousHighlightedSliceIndex=null
_previousDisplayMode=null
init(){super.init(...arguments),this._optionToSlice={}}didInsertElement(){super.didInsertElement(...arguments)
const t=this.element.querySelector("canvas")
this._chart=new window.Chart(t.getContext("2d"),this.chartConfig)}didReceiveAttrs(){super.didReceiveAttrs(...arguments),this._chart&&(this._updateDisplayMode(),this._updateHighlight())}willDestroy(){super.willDestroy(...arguments),this._chart&&this._chart.destroy()}colorStyle(t,e){return(0,s.htmlSafe)(`background: ${t[e]};`)}static#l=(()=>dt7948.n(this.prototype,"colorStyle",[(0,n.default)("optionColors","index")]))()
chartConfig(t,e){const l=[]
let s=0
this._optionToSlice={},t.forEach(((t,e)=>{t>0&&(l.push(t),this._optionToSlice[e]=s++)}))
const i=l.reduce(((t,e)=>t+e),0),n=(0,r.getColors)(t.length).filter(((e,l)=>t[l]>0))
return{type:p.PIE_CHART_TYPE,plugins:[window.ChartDataLabels],data:{datasets:[{data:l,backgroundColor:n,hoverBorderColor:"#fff"}]},options:{plugins:{tooltip:!1,datalabels:{color:"#333",backgroundColor:"rgba(255, 255, 255, 0.5)",borderRadius:2,font:{family:getComputedStyle(document.body).fontFamily,size:16},padding:{top:2,right:6,bottom:2,left:6},formatter(t){if("percentage"!==e)return t
return`${a.default.toNumber(t/i*100,{precision:1})}%`}}},responsive:!0,aspectRatio:1.1,animation:{duration:0},onHover:(t,e)=>{if(!e.length)return void(0,o.next)((()=>{this.setHighlightedOption(null)}))
const l=e[0].index,s=Object.keys(this._optionToSlice).find((t=>this._optionToSlice[t]===l));(0,o.next)((()=>{this.setHighlightedOption(Number(s))}))}}}}static#o=(()=>dt7948.n(this.prototype,"chartConfig",[(0,n.default)("data","displayMode")]))()
_updateDisplayMode(){if(this.displayMode!==this._previousDisplayMode){const t=this.chartConfig
this._chart.data.datasets=t.data.datasets,this._chart.options=t.options,this._chart.update(),this._previousDisplayMode=this.displayMode}}_updateHighlight(){const t=[]
if(this.highlightedOption){const e=this._optionToSlice[this.highlightedOption]
void 0!==e&&t.push({datasetIndex:0,index:e})}this._chart.setActiveElements(t),this._chart.update()}},[(0,i.classNames)("poll-breakdown-chart-container")])
t.default=(0,e.setComponentTemplate)(d,c)})),define("discourse/plugins/poll/discourse/components/poll-breakdown-option",["exports","@ember/component","@ember/object/computed","@ember/template","@ember-decorators/component","discourse/lib/computed","discourse-common/utils/decorators","discourse-i18n","discourse/plugins/poll/lib/chart-colors","@ember/template-factory"],(function(t,e,l,o,s,i,n,a,r,p){"use strict"
Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0
const u=(0,p.createTemplateFactory)({id:"NTR1m1S2",block:'[[[11,"li"],[24,0,"poll-breakdown-option"],[16,5,[30,0,["colorBackgroundStyle"]]],[24,"role","button"],[4,[38,0],["mouseover",[30,1]],null],[4,[38,0],["mouseout",[30,2]],null],[12],[1,"\\n  "],[10,1],[14,0,"poll-breakdown-option-color"],[15,5,[30,0,["colorPreviewStyle"]]],[12],[13],[1,"\\n\\n  "],[10,1],[14,0,"poll-breakdown-option-count"],[12],[1,"\\n"],[41,[30,0,["showPercentage"]],[[[1,"      "],[1,[30,0,["percent"]]],[1,"%\\n"]],[]],[[[1,"      "],[1,[30,3,["votes"]]],[1,"\\n"]],[]]],[1,"  "],[13],[1,"\\n  "],[10,1],[14,0,"poll-breakdown-option-text"],[12],[1,[28,[35,2],[[30,3,["html"]]],null]],[13],[1,"\\n"],[13]],["@onMouseOver","@onMouseOut","@option"],false,["on","if","html-safe"]]',moduleName:"discourse/plugins/poll/discourse/components/poll-breakdown-option.hbs",isStrictMode:!1}),d=dt7948.c(class extends e.default{option=null
index=null
totalVotes=null
optionsCount=null
displayMode=null
highlightedOption=null
onMouseOver=null
onMouseOut=null
static#t=(()=>dt7948.g(this.prototype,"highlighted",[(0,i.propertyEqual)("highlightedOption","index")]))()
#N=(()=>{dt7948.i(this,"highlighted")})()
static#l=(()=>dt7948.g(this.prototype,"showPercentage",[(0,l.equal)("displayMode","percentage")]))()
#R=(()=>{dt7948.i(this,"showPercentage")})()
percent(t,e){return a.default.toNumber(t/e*100,{precision:1})}static#o=(()=>dt7948.n(this.prototype,"percent",[(0,n.default)("option.votes","totalVotes")]))()
optionColors(t){return(0,r.getColors)(t)}static#s=(()=>dt7948.n(this.prototype,"optionColors",[(0,n.default)("optionsCount")]))()
colorBackgroundStyle(t){if(t)return(0,o.htmlSafe)("background: rgba(0, 0, 0, 0.1);")}static#i=(()=>dt7948.n(this.prototype,"colorBackgroundStyle",[(0,n.default)("highlighted")]))()
colorPreviewStyle(t,e,l){const s=t?window.Chart.helpers.getHoverColor(e[l]):e[l]
return(0,o.htmlSafe)(`background: ${s};`)}static#n=(()=>dt7948.n(this.prototype,"colorPreviewStyle",[(0,n.default)("highlighted","optionColors","index")]))()},[(0,s.tagName)("")])
t.default=(0,e.setComponentTemplate)(u,d)})),define("discourse/plugins/poll/discourse/initializers/add-poll-ui-builder",["exports","discourse/lib/plugin-api","discourse/plugins/poll/discourse/components/modal/poll-ui-builder"],(function(t,e,l){"use strict"
function o(t){t.addComposerToolbarPopupMenuOption({action:e=>{t.container.lookup("service:modal").show(l.default,{model:{toolbarEvent:e}})},icon:"chart-bar",label:"poll.ui_builder.title",condition:e=>{const l=t.container.lookup("service:site-settings"),o=t.getCurrentUser()
return l.poll_enabled&&(e.model.topic?.pm_with_non_human_user||o&&(o.staff||o.can_create_poll))}})}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0
t.default={name:"add-poll-ui-builder",initialize(){(0,e.withPluginApi)("1.14.0",o)}}})),define("discourse/plugins/poll/discourse/initializers/extend-for-poll",["exports","@ember/object","discourse/lib/plugin-api","discourse/widgets/glue","discourse-common/lib/get-owner","discourse-common/utils/decorators"],(function(t,e,l,o,s,i){"use strict"
Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0
const n="discourse-poll"
let a=[],r=null
function p(){a.forEach((t=>t.queueRerender()))}function u(){r&&(clearInterval(r),r=null),a.forEach((t=>t.cleanUp())),a=[]}function d(t){const l=(0,s.getRegister)(t),d=t.container.lookup("service:site-settings").poll_groupable_user_fields
u(),t.modifyClass("controller:topic",dt7948.p({pluginId:n,subscribe(){this._super(...arguments),this.messageBus.subscribe(`/polls/${this.model.id}`,this._onPollMessage)},unsubscribe(){this.messageBus.unsubscribe("/polls/*",this._onPollMessage),this._super(...arguments)},_onPollMessage(t){const e=this.get("model.postStream").findLoadedPost(t.post_id)
e?.set("polls",t.polls)}},[["method","_onPollMessage",[i.bind]]])),t.modifyClass("model:post",dt7948.p({pluginId:n,_polls:null,pollsObject:null,pollsChanged(){const t=this.polls
t&&(this._polls=this._polls||{},t.forEach((t=>{this._polls[t.name]?this._polls[t.name].setProperties(t):this._polls[t.name]=e.default.create(t)})),this.set("pollsObject",this._polls),p())}},[["method","pollsChanged",[(0,i.observes)("polls")]]])),t.includePostAttributes("polls","polls_votes"),t.decorateCookedElement((function(s,i){let n=[...s.querySelectorAll(".poll")]
if(n=n.filter((t=>"BLOCKQUOTE"!==t.parentNode.tagName)),!n.length||!i)return
const u=i.getModel()
t.preventCloak(u.id),u.pollsChanged()
const c=u.pollsObject||{},h=u.polls_votes||{}
r=r||setInterval(p,3e4),n.forEach((t=>{const s=t.dataset.pollName
let n=c[s],r=u,p=h[s]||[]
const m=t.closest(".expanded-quote")?.dataset.postId
if(m&&u.quoted[m]&&(r=u.quoted[m],r=e.default.create(r),n=e.default.create(r.polls.findBy("name",s)),p=r.polls_votes||{},p=p[s]||[]),n){const e=t.querySelector(".poll-title"),u={id:`${s}-${r.id}`,post:r,poll:n,vote:p,hasSavedVote:p.length>0,titleHTML:e?.outerHTML,groupableUserFields:(d||"").split("|").filter(Boolean),_postCookedWidget:i.widget},c=new o.default("discourse-poll",l,u)
c.appendTo(t),a.push(c)}}))}),{onlyStream:!0}),t.cleanupStream(u)
t.container.lookup("service:site-settings").poll_enabled&&t.addSearchSuggestion("in:polls")}t.default={name:"extend-for-poll",initialize(){(0,l.withPluginApi)("0.8.7",d)}}})),define("discourse/plugins/poll/discourse/widgets/discourse-poll",["exports","@ember/application","virtual-dom","discourse/lib/ajax","discourse/lib/ajax-error","discourse/lib/formatter","discourse/lib/load-script","discourse/lib/local-dates","discourse/lib/round","discourse/widgets/post","discourse/widgets/raw-html","discourse/widgets/widget","discourse-common/lib/icon-library","discourse-i18n","discourse/plugins/poll/lib/chart-colors","discourse/plugins/poll/lib/even-round","discourse/plugins/poll/discourse/components/modal/poll-breakdown","discourse/plugins/poll/discourse/components/modal/poll-ui-builder"],(function(t,e,l,o,s,i,n,a,r,p,u,d,c,h,m,g,f,b){"use strict"
Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0
const _={exportResults:{className:"btn-default export-results",label:"poll.export-results.label",title:"poll.export-results.title",icon:"download",action:"exportResults"},showBreakdown:{className:"btn-default show-breakdown",label:"poll.breakdown.breakdown",icon:"chart-pie",action:"showBreakdown"},openPoll:{className:"btn-default toggle-status",label:"poll.open.label",title:"poll.open.title",icon:"unlock-alt",action:"toggleStatus"},closePoll:{className:"btn-default toggle-status",label:"poll.close.label",title:"poll.close.title",icon:"lock",action:"toggleStatus"}}
function v(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}
const l=document.createElement("span")
return l.innerHTML=t.html,(0,a.applyLocalDates)(l.querySelectorAll(".discourse-local-date"),e),new u.default({html:`<span>${l.innerHTML}</span>`})}function y(t,e){const l=e&&e.groups&&e.groups.split(",").map((t=>t.toLowerCase()))
if(!l)return!0
const o=t&&t.groups&&t.groups.map((t=>t.name.toLowerCase()))
return o&&l.some((t=>o.includes(t)))}(0,d.createWidget)("discourse-poll-option",{tagName:"li",buildAttributes:t=>({tabindex:0,"data-poll-option-id":t.option.id}),html(t){const e=[],{option:l,vote:o}=t,s=o.includes(l.id)
return t.isMultiple?e.push((0,c.iconNode)(s?"far-check-square":"far-square")):e.push((0,c.iconNode)(s?"circle":"far-circle")),e.push(" "),e.push(v(l,this.siteSettings)),e},click(t){t.target.closest("a")||this.sendWidgetAction("toggleOption",this.attrs.option)},keyDown(t){"Enter"===t.key&&this.click(t)}}),(0,d.createWidget)("discourse-poll-load-more",{tagName:"div.poll-voters-toggle-expand",buildKey:t=>`load-more-${t.optionId}`,defaultState:()=>({loading:!1}),html:(t,e)=>e.loading?(0,l.h)("div.spinner.small"):(0,l.h)("a",(0,c.iconNode)("chevron-down")),click(){const{state:t,attrs:e}=this
if(!t.loading)return t.loading=!0,this.sendWidgetAction("fetchVoters",e.optionId).finally((()=>t.loading=!1))}}),(0,d.createWidget)("discourse-poll-voters",{tagName:"ul.poll-voters-list",buildKey:t=>`poll-voters-${t.optionId}`,html(t){const e=t.voters.map((t=>(0,l.h)("li",[(0,p.avatarFor)("tiny",{username:t.username,template:t.avatar_template})," "])))
return t.voters.length<t.totalVotes&&e.push(this.attach("discourse-poll-load-more",t)),(0,l.h)("div.poll-voters",e)}}),(0,d.createWidget)("discourse-poll-standard-results",{tagName:"ul.results",buildKey:t=>`poll-standard-results-${t.id}`,html(t){const{poll:e}=t,o=e.options
if(o){const s=e.voters,i=e.public,n=[...o].sort(((t,e)=>t.votes<e.votes?1:t.votes===e.votes?t.html<e.html?-1:1:-1)),a=0===s?Array(n.length).fill(0):n.map((t=>100*t.votes/s)),r=t.isMultiple?a.map(Math.floor):(0,g.default)(a)
return n.map(((o,s)=>{const n=[],a=r[s].toString(),p=(t.vote||[]).includes(o.id)
return n.push((0,l.h)("div.option",(0,l.h)("p",[(0,l.h)("span.percentage",`${a}%`),v(o,this.siteSettings)]))),n.push((0,l.h)("div.bar-back",(0,l.h)("div.bar",{attributes:{style:`width:${a}%`}}))),i&&n.push(this.attach("discourse-poll-voters",{postId:t.post.id,optionId:o.id,pollName:e.name,totalVotes:o.votes,voters:t.voters&&t.voters[o.id]||[]})),(0,l.h)("li",{className:""+(p?"chosen":"")},n)}))}}}),(0,d.createWidget)("discourse-poll-number-results",{buildKey:t=>`poll-number-results-${t.id}`,html(t){const{poll:e}=t,o=e.options.reduce(((t,e)=>t+parseInt(e.html,10)*parseInt(e.votes,10)),0),s=e.voters,i=0===s?0:(0,r.default)(o/s,-2),n=h.default.t("poll.average_rating",{average:i}),a=[(0,l.h)("div.poll-results-number-rating",new u.default({html:`<span>${n}</span>`}))]
return e.public&&a.push(this.attach("discourse-poll-voters",{totalVotes:e.voters,voters:t.voters||[],postId:t.post.id,pollName:e.name,pollType:e.type})),a}}),(0,d.createWidget)("discourse-poll-container",{tagName:"div.poll-container",buildKey:t=>`poll-container-${t.id}`,services:["dialog"],defaultState:()=>({voters:[]}),html(t,e){const{poll:o}=t,s=o.options
if(t.showResults){const l=[]
t.titleHTML&&l.push(new u.default({html:t.titleHTML})),o.public&&(e.voters=o.preloaded_voters)
const s="number"===o.type?"number":"standard",i="number"===s||t.poll.chart_type!==b.PIE_CHART_TYPE?`discourse-poll-${s}-results`:"discourse-poll-pie-chart"
return l.push(this.attach(i,{...t,voters:e.voters})),l}if(s){const e=[]
return t.titleHTML&&e.push(new u.default({html:t.titleHTML})),y(this.currentUser,o)||e.push((0,l.h)("div.alert.alert-danger",h.default.t("poll.results.groups.title",{groups:o.groups}))),e.push((0,l.h)("ul",s.map((e=>this.attach("discourse-poll-option",{option:e,isMultiple:t.isMultiple,vote:t.vote}))))),e}},fetchVoters(t){const{attrs:e,state:l}=this
let i
return t?(l.voters||(l.voters={}),l.voters[t]||(l.voters[t]=[]),i=l.voters[t].length):(l.voters||(l.voters=[]),i=l.voters.length),(0,o.ajax)("/polls/voters.json",{data:{post_id:e.post.id,poll_name:e.poll.name,option_id:t,page:Math.floor(i/25)+1,limit:25}}).then((o=>{const s=t?l.voters[t]:l.voters,i=t?o.voters[t]:o.voters,n=new Set(s.map((t=>t.username)))
i.forEach((t=>{n.has(t.username)||(n.add(t.username),s.push(t))})),"regular"===e.poll.type&&Object.keys(l.voters).forEach((e=>{t!==e&&(l.voters[e]=l.voters[e].filter((t=>!n.has(t.username))))})),this.scheduleRerender()})).catch((t=>{t?(0,s.popupAjaxError)(t):this.dialog.alert(h.default.t("poll.error_while_fetching_voters"))}))}}),(0,d.createWidget)("discourse-poll-info",{tagName:"div.poll-info",multipleHelpText(t,e,l){if(e>0)if(t===e){if(t>1)return h.default.t("poll.multiple.help.x_options",{count:t})}else{if(t>1)return e<l?h.default.t("poll.multiple.help.between_min_and_max_options",{min:t,max:e}):h.default.t("poll.multiple.help.at_least_min_options",{count:t})
if(e<=l)return h.default.t("poll.multiple.help.up_to_max_options",{count:e})}},html(t){const{poll:e,post:o}=t,s=t.isClosed,n=this.currentUser&&this.currentUser.staff,a=this.currentUser&&o.user_id===this.currentUser.id,r=e.voters,p=[(0,l.h)("div.poll-info_counts-count",[(0,l.h)("span.info-number",r.toString()),(0,l.h)("span.info-label",h.default.t("poll.voters",{count:r}))])],d=[]
if(t.isMultiple)if(t.showResults||t.isClosed){const t=e.options.reduce(((t,e)=>t+parseInt(e.votes,10)),0)
p.push((0,l.h)("div.poll-info_counts-count",[(0,l.h)("span.info-number",t.toString()),(0,l.h)("span.info-label",h.default.t("poll.total_votes",{count:t}))]))}else{const l=this.multipleHelpText(t.min,t.max,e.options.length)
l&&d.push(new u.default({html:`<li>\n                      ${(0,c.iconHTML)("list-ul")}\n                      <span>${l}</span>\n                     </li>`}))}if(e.close){const l=moment.utc(e.close,"YYYY-MM-DD HH:mm:ss Z")
if(l.isValid()){const e=l.format("LLL")
let o,s
if(t.isAutomaticallyClosed){const t=(0,i.relativeAge)(l.toDate(),{addAgo:!0})
o=h.default.t("poll.automatic_close.age",{age:t}),s="lock"}else{const t=moment().to(l,!0)
o=h.default.t("poll.automatic_close.closes_in",{timeLeft:t}),s="far-clock"}d.push(new u.default({html:`<li title="${e}">\n                    ${(0,c.iconHTML)(s)}\n                    <span>${o}</span>\n                   </li>`}))}}let m
return"on_vote"!==e.results||t.hasVoted||a?"on_close"!==e.results||s?"staff_only"!==e.results||n||(m=new u.default({html:`<li>\n                ${(0,c.iconHTML)("shield-alt")}\n                <span>${h.default.t("poll.results.staff.title")}</span>\n               </li>`})):m=new u.default({html:`<li>\n                ${(0,c.iconHTML)("lock")}\n                <span>${h.default.t("poll.results.closed.title")}</span>\n               </li>`}):m=new u.default({html:`<li>\n                ${(0,c.iconHTML)("check")}\n                <span>${h.default.t("poll.results.vote.title")}</span>\n               </li>`}),m&&d.push(m),t.isClosed||t.showResults||!e.public||"staff_only"===e.results||d.push(new u.default({html:`<li>\n                  ${(0,c.iconHTML)("far-eye")}\n                  <span>${h.default.t("poll.public.title")}</span>\n                 </li>`})),[(0,l.h)("div.poll-info_counts",p),(0,l.h)("ul.poll-info_instructions",d)]}}),(0,d.createWidget)("discourse-poll-pie-canvas",{tagName:"canvas.poll-results-canvas",init(t){(0,n.default)("/javascripts/Chart.min.js").then((()=>{const e=function(t,e){let l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{}
const o="aspectRatio"in l?l.aspectRatio:2.2,s=e.map((t=>{return e=t,(new DOMParser).parseFromString(e,"text/html").body.textContent||""
var e}))
return{type:b.PIE_CHART_TYPE,data:{datasets:[{data:t,backgroundColor:(0,m.getColors)(t.length)}],labels:s},plugins:[w],options:{responsive:!0,aspectRatio:o,animation:{duration:0},plugins:{legend:{labels:{generateLabels:()=>e.map(((e,l)=>({fillStyle:(0,m.getColors)(t.length)[l],text:e,index:l})))},display:!1},htmlLegend:{containerID:l?.legendContainerId}}}}}(t.poll.options.mapBy("votes"),t.poll.options.mapBy("html"),{legendContainerId:`poll-results-legend-${t.id}`}),l=document.getElementById(`poll-results-chart-${t.id}`)
this._chart=new Chart(l.getContext("2d"),e)}))},willRerenderWidget(){this._chart?.destroy()},buildAttributes:t=>({id:`poll-results-chart-${t.id}`})}),(0,d.createWidget)("discourse-poll-pie-chart",{tagName:"div.poll-results-chart",html(t){const e=[]
if(!t.showResults)return function(t){let e=document.querySelector(`#poll-results-chart-${t}`)
e&&e.parentNode.removeChild(e)}(t.id),e
const o=this.attach("discourse-poll-pie-canvas",t)
return e.push(o),e.push((0,l.h)(`ul#poll-results-legend-${t.id}.pie-chart-legends`)),e}})
const w={id:"htmlLegend",afterUpdate(t,e,l){const o=document.getElementById(l.containerID)
o.innerHTML=""
t.options.plugins.legend.labels.generateLabels(t).forEach((e=>{const l=document.createElement("li")
l.classList.add("legend"),l.onclick=()=>{t.toggleDataVisibility(e.index),t.update()}
const s=document.createElement("span")
s.classList.add("swatch"),s.style.background=e.fillStyle
const i=document.createElement("span")
i.style.color=e.fontColor,i.innerHTML=e.text,t.getDataVisibility(e.index)?l.style.opacity=1:l.style.opacity=.2,l.appendChild(s),l.appendChild(i),o.appendChild(l)}))}};(0,d.createWidget)("discourse-poll-buttons-dropdown",{tagName:"div.poll-buttons-dropdown",buildId:t=>`poll-buttons-dropdown-${t.id}`,transform(t){return{content:this._buildContent(t),onChange:t=>this.sendWidgetAction(t.id,t.param)}},template:function(t,e){var l=[]
return l.push("\n  "),l.push(this.attach("widget-dropdown",{id:this.attrs.id,icon:"cog",label:"poll.options.label",content:this.transformed.content,onChange:this.transformed.onChange,options:this.transformed.options},void 0,void 0)),l.push("\n"),l},optionsCount(t){return this._buildContent(t).length},_buildContent(t){const e=[],l=this.currentUser&&this.currentUser.admin,o=this.siteSettings.data_explorer_enabled,s=this.siteSettings.poll_export_data_explorer_query_id,{poll:i,post:n}=t,a=t.isClosed,r=this.currentUser&&this.currentUser.staff,p=n.get("topic.archived")
if(t.groupableUserFields.length&&i.voters>0){const t={..._.showBreakdown}
t.id=t.action,e.push(t)}if(l&&o&&i.voters>0&&s){const t={..._.exportResults}
t.id=t.action,e.push(t)}if(this.currentUser&&(this.currentUser.id===n.user_id||r)&&!p)if(a){if(!t.isAutomaticallyClosed){const t={..._.openPoll}
t.id=t.action,e.push(t)}}else{const t={..._.closePoll}
t.id=t.action,e.push(t)}return e}}),(0,d.createWidget)("discourse-poll-buttons",{tagName:"div.poll-buttons",html(t){const e=[],{poll:l,post:o}=t,s=o.get("topic.archived"),i=t.isClosed,n="staff_only"===l.results,a=this.currentUser&&this.currentUser.staff,r=this.currentUser&&o.user_id===this.currentUser.id,p=!n&&(i||s),u=this.attach("discourse-poll-buttons-dropdown",t),d=u.optionsCount(t)
if(t.isMultiple&&!p&&!t.showResults){const l=!t.canCastVotes
e.push(this.attach("button",{className:"cast-votes "+(l?"btn-default":"btn-primary"),label:"poll.cast-votes.label",title:"poll.cast-votes.title",icon:l?"far-square":"check",disabled:l,action:"castVotes"}))}if(t.showResults&&!p&&e.push(this.attach("button",{className:"btn-default toggle-results",label:"poll.hide-results.label",title:"poll.hide-results.title",icon:"chevron-left",action:"toggleResults"})),!t.showResults&&!p){let o;("on_vote"!==l.results||t.hasVoted||r)&&("on_close"!==l.results||i)&&("staff_only"!==l.results||a)&&l.voters>0&&(o=this.attach("button",{className:"btn-default toggle-results",label:"poll.show-results.label",title:"poll.show-results.title",icon:"chart-bar",action:"toggleResults"})),t.hasSavedVote&&e.push(this.attach("button",{className:"btn-default remove-vote",label:"poll.remove-vote.label",title:"poll.remove-vote.title",icon:"undo",action:"removeVote"})),o&&e.push(o)}if(d>1)e.push(u)
else if(1===d){const l=u._buildContent(t)[0].id
let o=_[l]
"toggleStatus"===l&&(o=i?_.openPoll:_.closePoll),e.push(this.attach("button",o))}return[e]}})
t.default=(0,d.createWidget)("discourse-poll",{tagName:"div",buildKey:t=>`poll-${t.id}`,services:["dialog"],buildAttributes(t){let e="poll"
return t.poll.chart_type===b.PIE_CHART_TYPE&&(e+=" pie"),{class:e,"data-poll-name":t.poll.name,"data-poll-type":t.poll.type}},defaultState(t){const{poll:e}=t,l="staff_only"===t.poll.results
return{loading:!1,showResults:"on_close"!==e.results&&this.hasVoted()&&!l}},html(t,e){const l="staff_only"===t.poll.results,o=e.showResults||t.post.get("topic.archived")&&!l||this.isClosed()&&!l,s={...t,canCastVotes:this.canCastVotes(),hasVoted:this.hasVoted(),isAutomaticallyClosed:this.isAutomaticallyClosed(),isClosed:this.isClosed(),isMultiple:this.isMultiple(),max:this.max(),min:this.min(),showResults:o}
return[this.attach("discourse-poll-container",s),this.attach("discourse-poll-info",s),this.attach("discourse-poll-buttons",s)]},min(){let t=parseInt(this.attrs.poll.min,10)
return(isNaN(t)||t<0)&&(t=1),t},max(){let t=parseInt(this.attrs.poll.max,10)
const e=this.attrs.poll.options.length
return(isNaN(t)||t>e)&&(t=e),t},isAutomaticallyClosed(){const{poll:t}=this.attrs
return t.close&&moment.utc(t.close,"YYYY-MM-DD HH:mm:ss Z")<=moment()},isClosed(){const{poll:t}=this.attrs
return"closed"===t.status||this.isAutomaticallyClosed()},isMultiple(){const{poll:t}=this.attrs
return"multiple"===t.type},hasVoted(){const{vote:t}=this.attrs
return t&&t.length>0},canCastVotes(){const{state:t,attrs:e}=this
if(this.isClosed()||t.showResults||t.loading)return!1
const l=e.vote.length
return this.isMultiple()?l>=this.min()&&l<=this.max():l>0},toggleStatus(){const{state:t,attrs:e}=this,{post:l,poll:i}=e
this.isAutomaticallyClosed()||this.dialog.yesNoConfirm({message:h.default.t(this.isClosed()?"poll.open.confirm":"poll.close.confirm"),didConfirm:()=>{t.loading=!0
const e=this.isClosed()?"open":"closed";(0,o.ajax)("/polls/toggle_status",{type:"PUT",data:{post_id:l.id,poll_name:i.name,status:e}}).then((()=>{i.set("status",e),"on_close"===i.results&&(t.showResults="closed"===e),this.scheduleRerender()})).catch((t=>{t?(0,s.popupAjaxError)(t):this.dialog.alert(h.default.t("poll.error_while_toggling_status"))})).finally((()=>{t.loading=!1}))}})},toggleResults(){this.state.showResults=!this.state.showResults},removeVote(){const{attrs:t,state:e}=this
return e.loading=!0,(0,o.ajax)("/polls/vote",{type:"DELETE",data:{post_id:t.post.id,poll_name:t.poll.name}}).then((e=>{let{poll:l}=e
t.poll.setProperties(l),t.vote.length=0,t.hasSavedVote=!1,this.appEvents.trigger("poll:voted",l,t.post,t.vote)})).catch((t=>(0,s.popupAjaxError)(t))).finally((()=>{e.loading=!1}))},exportResults(){const{attrs:t}=this,e=this.siteSettings.poll_export_data_explorer_query_id;(0,o.ajax)(`/admin/plugins/explorer/queries/${e}/run.csv`,{type:"POST",data:{params:JSON.stringify({poll_name:t.poll.name,post_id:t.post.id.toString()}),explain:!1,limit:1e6,download:1}}).then((e=>{const l=document.createElement("a"),o=new Blob([e],{type:"text/csv;charset=utf-8;"})
l.href=URL.createObjectURL(o),l.setAttribute("download",`poll-export-${t.poll.name}-${t.post.id}.csv`),l.click(),l.remove()})).catch((t=>{t?(0,s.popupAjaxError)(t):this.dialog.alert(h.default.t("poll.error_while_exporting_results"))}))},showLogin(){this.register.lookup("route:application").send("showLogin")},_toggleOption(t){const{vote:e}=this.attrs,l=e.indexOf(t.id);-1!==l?e.splice(l,1):e.push(t.id)},toggleOption(t){const{attrs:e}=this
if(this.isClosed())return
if(!this.currentUser)return this.showLogin()
if(!y(this.currentUser,this.attrs.poll))return
const{vote:l}=e
return this.isMultiple()||1!==l.length||l[0]!==t.id?(this.isMultiple()||(l.length=0),this._toggleOption(t),this.isMultiple()?void 0:this.castVotes().catch((()=>this._toggleOption(t)))):this.removeVote()},castVotes(){if(!this.canCastVotes())return
if(!this.currentUser)return this.showLogin()
const{attrs:t,state:e}=this
return e.loading=!0,(0,o.ajax)("/polls/vote",{type:"PUT",data:{post_id:t.post.id,poll_name:t.poll.name,options:t.vote}}).then((l=>{let{poll:o}=l
t.hasSavedVote=!0,t.poll.setProperties(o),this.appEvents.trigger("poll:voted",o,t.post,t.vote),"on_close"!==t.poll.results&&(e.showResults=!0),"staff_only"===t.poll.results&&(this.currentUser&&this.currentUser.staff?e.showResults=!0:e.showResults=!1)})).catch((t=>{t?(0,s.popupAjaxError)(t):this.dialog.alert(h.default.t("poll.error_while_casting_votes"))})).finally((()=>{e.loading=!1}))},showBreakdown(){(0,e.getOwner)(this).lookup("service:modal").show(f.default,{model:this.attrs})}})})),define("discourse/plugins/poll/lib/chart-colors",["exports"],(function(t){"use strict"
Object.defineProperty(t,"__esModule",{value:!0}),t.getColors=function(t,e){let l
switch(e=e||"cool"){case"cool":l={0:[255,255,255],25:[220,237,200],50:[66,179,213],75:[26,39,62],100:[0,0,0]}
break
case"warm":l={0:[255,255,255],25:[254,235,101],50:[228,82,27],75:[77,52,47],100:[0,0,0]}}let o,s,i=Object.keys(l),n=[]
for(let a=0;a<t;a++){let e
o=(a+1)*(100/(t+1)),s=s||0
for(let t=s;t<i.length;t++){if(!i[t+1]){e=t-1
break}if(o>=i[t]&&o<i[t+1]){e=t
break}}let r=(o-i[e])/(i[e+1]-i[e]),p=[]
for(let t=0;t<3;t++)p.push(Math.round(l[i[e]][t]-(l[i[e]][t]-l[i[e+1]][t])*r))
n.push(`rgb(${p.toString()})`),s=e}return n}})),define("discourse/plugins/poll/lib/discourse-markdown/poll",["exports","discourse-i18n"],(function(t,e){"use strict"
Object.defineProperty(t,"__esModule",{value:!0}),t.setup=function(t){t.allowList(["a.button.cast-votes","a.button.toggle-results","div.poll-buttons","div.poll-container","div.poll-info_counts-count","div.poll-info_counts","div.poll-info","div.poll-title","div.poll","div[data-*]","li[data-*]","span.info-label","span.info-number","span.info-text"]),t.registerOptions(((t,e)=>{t.features.poll=e.poll_enabled,t.pollMaximumOptions=e.poll_maximum_options})),t.registerPlugin((t=>t.block.bbcode.ruler.push("poll",n)))}
/*!
   * Joseph Myer's md5() algorithm wrapped in a self-invoked function to prevent
   * global namespace pollution, modified to hash unicode characters as UTF-8.
   *
   * Copyright 1999-2010, Joseph Myers, Paul Johnston, Greg Holt, Will Bond <will@wbond.net>
   * http://www.myersdaily.org/joseph/javascript/md5-text.html
   * http://pajhome.org.uk/crypt/md5
   *
   * Released under the BSD license
   * http://www.opensource.org/licenses/bsd-license
   */
const l="data-poll-",o={name:"poll",status:"open"},s=["chartType","close","groups","max","min","name","order","public","results","status","step","type"]
function i(t,e,o){let s=t.push("poll_container_open","div",1)
s.attrs=[["class","poll-container"]],e.length>0&&(s=t.push("poll_title_open","div",1),s.attrs=[["class","poll-title"]],t.tokens.push(...e),t.push("poll_title_close","div",-1))
for(let i=0;i<o.length;i++)if("list_item_open"===o[i].type){let t=o.findIndex(((t,e)=>e>i&&"list_item_close"===t.type))
if(-1===t)continue
let e=o.slice(i,t+1).filter((t=>"text"===t.type||"inline"===t.type)).map((t=>t.content)).join(" "),s=function(t){for(let e=0;e<t.length;e++)t[e]=g(t[e])
return t.join("")}(function(t){t=unescape(encodeURI(t))
let e,l=t.length,o=[1732584193,-271733879,-1732584194,271733878]
for(e=64;e<=t.length;e+=64)a(o,h(t.substring(e-64,e)))
t=t.substring(e-64)
let s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
for(e=0;e<t.length;e++)s[e>>2]|=t.charCodeAt(e)<<(e%4<<3)
if(s[e>>2]|=128<<(e%4<<3),e>55)for(a(o,s),e=0;e<16;e++)s[e]=0
return s[14]=8*l,a(o,s),o}(JSON.stringify([e])))
o[i].attrs||=[],o[i].attrs.push([l+"option-id",s])}t.tokens.push(...o),t.push("poll_container_close","div",-1)}const n={tag:"poll",before(t,e){let{attrs:l}=e
t.tokens.filter((t=>"poll_open"===t.type)).length>t.tokens.filter((t=>"poll_close"===t.type)).length||(t.push("poll_open","div",1).poll_attrs={...o,...l})},after(t,o){if("poll_open"!==o.type)return
let n=o.poll_attrs,a=t.tokens.indexOf(o),r=t.tokens.slice(a+1),p=[]
if(r.length>0&&"heading_open"===r[0].type){let e=r.findIndex((t=>"heading_close"===t.type));-1!==e&&(p=r.splice(0,e+1).slice(1,-1),t.tokens.splice(a+1,e+1))}if("number"===n.type){let e=parseInt(n.min,10),l=parseInt(n.max,10),o=parseInt(n.step,10)
if(isNaN(e)&&(e=1),isNaN(l)&&(l=t.md.options.discourse.pollMaximumOptions),(isNaN(o)||o<1)&&(o=1),r.length>0)return void t.tokens.splice(a,1)
e<=l&&function(t,e,l,o,s){e.push(new t.Token("bullet_list_open","ul",1))
for(let i=l;i<=o;i+=s){e.push(new t.Token("list_item_open","li",1))
let l=new t.Token("text","",0)
l.content=String(i),e.push(l),e.push(new t.Token("list_item_close","li",-1))}e.push(new t.Token("bullet_list_close","ul",-1))}(t,r,e,l,o)}t.tokens.splice(a+1),o.attrs||=[],o.attrs.push(["class","poll"])
for(let e of s)n[e]&&o.attrs.push([l+e,n[e]])
r.length>0&&!r[0].type.endsWith("_list_open")||(i(t,p,r),function(t){let l=t.push("poll_info_open","div",1)
l.attrs=[["class","poll-info"]],l=t.push("poll_info_counts_open","div",1),l.attrs=[["class","poll-info_counts"]],l=t.push("poll_info_counts_count_open","div",1),l.attrs=[["class","poll-info_counts-count"]],l=t.push("poll_info_number_open","span",1),l.attrs=[["class","info-number"]],l.block=!1,l=t.push("text","",0),l.content="0",t.push("poll_info_number_close","span",-1),l=t.push("poll_info_label_open","span",1),l.attrs=[["class","info-label"]],l.block=!1,l=t.push("text","",0),l.content=e.default.t("poll.voters",{count:0}),t.push("poll_info_label_close","span",-1),t.push("poll_info_counts_count_close","div",-1),t.push("poll_info_counts_close","div",-1),t.push("poll_info_close","div",-1)}(t),t.push("poll_close","div",-1))}}
function a(t,e){let l=t[0],o=t[1],s=t[2],i=t[3]
l=p(l,o,s,i,e[0],7,-680876936),i=p(i,l,o,s,e[1],12,-389564586),s=p(s,i,l,o,e[2],17,606105819),o=p(o,s,i,l,e[3],22,-1044525330),l=p(l,o,s,i,e[4],7,-176418897),i=p(i,l,o,s,e[5],12,1200080426),s=p(s,i,l,o,e[6],17,-1473231341),o=p(o,s,i,l,e[7],22,-45705983),l=p(l,o,s,i,e[8],7,1770035416),i=p(i,l,o,s,e[9],12,-1958414417),s=p(s,i,l,o,e[10],17,-42063),o=p(o,s,i,l,e[11],22,-1990404162),l=p(l,o,s,i,e[12],7,1804603682),i=p(i,l,o,s,e[13],12,-40341101),s=p(s,i,l,o,e[14],17,-1502002290),o=p(o,s,i,l,e[15],22,1236535329),l=u(l,o,s,i,e[1],5,-165796510),i=u(i,l,o,s,e[6],9,-1069501632),s=u(s,i,l,o,e[11],14,643717713),o=u(o,s,i,l,e[0],20,-373897302),l=u(l,o,s,i,e[5],5,-701558691),i=u(i,l,o,s,e[10],9,38016083),s=u(s,i,l,o,e[15],14,-660478335),o=u(o,s,i,l,e[4],20,-405537848),l=u(l,o,s,i,e[9],5,568446438),i=u(i,l,o,s,e[14],9,-1019803690),s=u(s,i,l,o,e[3],14,-187363961),o=u(o,s,i,l,e[8],20,1163531501),l=u(l,o,s,i,e[13],5,-1444681467),i=u(i,l,o,s,e[2],9,-51403784)
s=u(s,i,l,o,e[7],14,1735328473),o=u(o,s,i,l,e[12],20,-1926607734),l=d(l,o,s,i,e[5],4,-378558),i=d(i,l,o,s,e[8],11,-2022574463),s=d(s,i,l,o,e[11],16,1839030562),o=d(o,s,i,l,e[14],23,-35309556),l=d(l,o,s,i,e[1],4,-1530992060),i=d(i,l,o,s,e[4],11,1272893353),s=d(s,i,l,o,e[7],16,-155497632),o=d(o,s,i,l,e[10],23,-1094730640),l=d(l,o,s,i,e[13],4,681279174),i=d(i,l,o,s,e[0],11,-358537222),s=d(s,i,l,o,e[3],16,-722521979),o=d(o,s,i,l,e[6],23,76029189),l=d(l,o,s,i,e[9],4,-640364487),i=d(i,l,o,s,e[12],11,-421815835),s=d(s,i,l,o,e[15],16,530742520),o=d(o,s,i,l,e[2],23,-995338651),l=c(l,o,s,i,e[0],6,-198630844),i=c(i,l,o,s,e[7],10,1126891415),s=c(s,i,l,o,e[14],15,-1416354905),o=c(o,s,i,l,e[5],21,-57434055),l=c(l,o,s,i,e[12],6,1700485571),i=c(i,l,o,s,e[3],10,-1894986606),s=c(s,i,l,o,e[10],15,-1051523),o=c(o,s,i,l,e[1],21,-2054922799),l=c(l,o,s,i,e[8],6,1873313359),i=c(i,l,o,s,e[15],10,-30611744),s=c(s,i,l,o,e[6],15,-1560198380),o=c(o,s,i,l,e[13],21,1309151649)
l=c(l,o,s,i,e[4],6,-145523070),i=c(i,l,o,s,e[11],10,-1120210379),s=c(s,i,l,o,e[2],15,718787259),o=c(o,s,i,l,e[9],21,-343485551),t[0]=f(l,t[0]),t[1]=f(o,t[1]),t[2]=f(s,t[2]),t[3]=f(i,t[3])}function r(t,e,l,o,s,i){return e=f(f(e,t),f(o,i)),f(e<<s|e>>>32-s,l)}function p(t,e,l,o,s,i,n){return r(e&l|~e&o,t,e,s,i,n)}function u(t,e,l,o,s,i,n){return r(e&o|l&~o,t,e,s,i,n)}function d(t,e,l,o,s,i,n){return r(e^l^o,t,e,s,i,n)}function c(t,e,l,o,s,i,n){return r(l^(e|~o),t,e,s,i,n)}function h(t){let e,l=[]
for(e=0;e<64;e+=4)l[e>>2]=t.charCodeAt(e)+(t.charCodeAt(e+1)<<8)+(t.charCodeAt(e+2)<<16)+(t.charCodeAt(e+3)<<24)
return l}let m="0123456789abcdef".split("")
function g(t){let e="",l=0
for(;l<4;l++)e+=m[t>>8*l+4&15]+m[t>>8*l&15]
return e}function f(t,e){return t+e&4294967295}})),define("discourse/plugins/poll/lib/even-round",["exports"],(function(t){"use strict"
function e(t){return 100===t.map((t=>Math.floor(t))).reduce(((t,e)=>t+e))}Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(t){let l=t.map((t=>t%1))
const o=Math.ceil(l.reduce(((t,e)=>t+e)))
for(let s=0,i=l.length;s<o&&s<i;s++){let o=0,s=0
for(let t=0;t<l.length;t++)l[t]>o&&(s=t,o=l[t])
if(++t[s],l[s]=0,e(t))break}return t.map((t=>Math.floor(t)))}}))

//# sourceMappingURL=poll-07975dea5bc1c218e4ddde3d4628fa5dd95889832e9003fff6c2a9d27ac4ef81.map
//!

;
